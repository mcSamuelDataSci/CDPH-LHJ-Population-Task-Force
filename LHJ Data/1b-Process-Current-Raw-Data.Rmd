---
title: "Pulling and Processing Recent Raw Population Data"
author: "Jaspreet Kang"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Introduction

Note: This Rmarkdown is largely the same as *1a-Process-Historical-Raw-Data.Rmd*, except that it processes recent and current population datasets. Therefore, this file must be maintained, updated, and executed whenever a new population data file (either from Department of Finance or Census Decennial) is released.

This RMarkdown file extracts and processes current population data necessary for creating sex-age-race/ethnicity estimates for all 61 California Local Health Jurisdictions:

-   58 counties
-   3 city-based jurisdictions: Berkeley, Long Beach, and Pasadena
-   Alameda LHJ
-   Los Angeles LHJ

## Population Data Required:

The population data files extracted and processed include:

1.  Department of Finance (DOF) P3 Complete State and County Projections Dataset

    1.  Files processed:

        1.  *P3/P3_Complete_2010-2060.csv*

            1.  Vintage 2020 (released 2021.7.14)

            2.  File not available for download on DOF's website.

            3.  2010-2019 population estimates are used.

        2.  *P3/P3_Complete_2020-2060.csv*

            1.  Vintage 2023 (released 2024.3.8)

            2.  Downloaded from [here](https://dof.ca.gov/forecasting/demographics/projections/)

            3.  2020-2023 population estimates are used.

        3.  Note: Both files contain January 1st sex by age by race/ethnicity population estimates at the county-level.

2.  2020 Census Decennial for county- and city-level Sex-Age-Race/Ethnicity population (April 1st estimates)

    1.  Extracted using R's [tidycensus](https://github.com/walkerke/tidycensus) package. This method requires a Census API key, which can be obtained [here](https://api.census.gov/data/key_signup.html). Estimates are pulled from the 2020 Decennial.

### Optional

Department of Finance P3 data are January 1 estimates. The files below allow for the adjustment of DOF P3 data to July 1 population rather than January 1.

3.  Department of Finance - E-4 Population Estimates for Cities, Counties, and the State

    1.  Excel files of these data were downloaded from [here](https://dof.ca.gov/forecasting/demographics/estimates/), and are stored in *E4/Raw/*. The raw data were then manually formatted for easier processing and stored into *E4/Clean/*.

    2.  Contains January 1st county- and city-level total estimates from 2011-2023

4.  Department of Finance - E-6 Population Estimates and Components of Change by County

    1.  Excel files of these data were downloaded from [here](https://dof.ca.gov/forecasting/demographics/estimates/), and are stored in *E6/Raw/*. The raw data were then manually formatted for easier processing stored into *E6/Clean/.*

    2.  Contains July 1st county-level total estimates from 2010-2023

Note: The data structure and formatting between each of DOF's raw E-4 and E-6 files are largely inconsistent. Therefore, these files were first manually converted to a standard format.

## Data File Outputs:

The processed datasets are saved as csv and RDS files into *intermediatePopData/*:

1.  *dof-p3-processed-current*
2.  *census-city-ars-current*
3.  *census-county-ars-current*
4.  *dof-e4-processed-current*
5.  *dof-e6-processed-current*

# Processing

## Setup

R version 4.0.4 (2021-02-15)

Platform: x86_64-pc-linz-gnu (64-bit)

RStudio Workbench Version 1.4.1717-3: "Juliet Rose" (23fd1677, 2021-05-27) for CentOS 8

Package versions:

-   readxl - 1.3.1

-   readr - 2.1.4

-   dplyr - 1.1.3

-   tidyr - 1.3.0

-   tidycensus - 1.5

-   janitor - 2.1.0

-   stringr - 1.5.0

-   lubridate - 1.9.3

Note: The final product (LHJ-level sex-age-race/ethnicity population estimates - created in *3-Create-LHJ-Population-ARS.Rmd*) spans from 2000 to the year value set to the **currentYear** object below.

```{r}

# Setup ========================================================================================

# Disable scientific notation
options(scipen=999)

## Load packages ----------------------------------------------
library(readxl) # Read in excel files
library(readr) # Read in and write csv files
library(dplyr) # Data manipulation
library(tidyr) # Data reshaping
library(janitor) # Contains helpful functions for data cleaning
library(lubridate) # Date formatting
library(stringr) # String formatting
library(tidycensus) # For interacting with Census API

## Global constants ---------------------------------------------

# Set current year
currentYear <- 2023

# City LHJs
cities <- c("Berkeley", "Long Beach", "Pasadena")


# Directory to save output files to
outputDir <- "intermediatePopData/"

```

## Process and Save Data

### (Required) Department of Finance's P3 Complete State and County Projections Dataset

Steps:

1.  Read in relationship files, located in *Standards/*

    1.  *countyLink.xlsx* - Used for linking DOF's county fip codes to county names.

    2.  *raceLink.xlsx* - Used for linking DOF's race/ethnicity codes to a standard set of race/ethnicity labels.

2.  Read in DOF's P3 Complete State and County Projections files

    1.  *P3/P3_Complete_2010-2060.csv*

        1.  2010-2019 population estimates are used.

    2.  *P3/P3_Complete_2020-2060.csv*

        1.  2020-2023 population estimates are used.

    3.  Note: Both files contain January 1st sex by age by race/ethnicity population estimates.

3.  Process data

4.  Save data as .RDS and .csv into *intermediatePopData/*

    1.  *dof-p3-processed-current.RDS*

    2.  *dof-p3-processed-current.csv*

```{r}

# County relationship file =======
countyLink <- read_xlsx("Standards/countyLink.xlsx") %>% 
  select(county = countyName, fips = FIPSCounty) %>% 
  mutate(fips = as.numeric(paste0("6", fips)))

raceLink <- read_xlsx("Standards/raceLink.xlsx") %>% 
  select(race7, raceEth = raceNameShort) %>% 
  filter(!is.na(race7))

# Read in and process data =======

# 2010-2019 ---------------------
# Vintage 2020 (2021.7.14) version
p3_10_19 <- read_csv("P3/P3_Complete_2010-2060.csv") %>%
  filter(year %in% 2010:2019) %>% 
  left_join(countyLink, by = "fips") %>% 
  mutate(sex = str_to_title(sex)) %>% 
  select(county, year, sex, race7, age = agerc, population = perwt)


# 2020 - Current --------------
# Vintage 2023 (2024.3.8) version
p3_20_ <- read_csv("P3/P3_Complete_2020-2060.csv") %>% 
  filter(year %in% 2020:currentYear) %>% 
  left_join(countyLink, by = "fips") %>% 
  mutate(sex = str_to_title(sex)) %>% 
  select(county, year, sex, race7, age = agerc, population = perwt)

# Bind data ===================
p3_final <- bind_rows(p3_10_19, p3_20_) %>% 
  left_join(raceLink) %>% 
  select(-race7) %>% 
  mutate(age = case_when(age >= 100 ~ "100+", 
                         TRUE ~ as.character(age))) %>% 
  group_by(county, year, sex, age, raceEth) %>% 
  summarise(population = sum(population)) %>% 
  ungroup()

# Save data =======
saveRDS(p3_final, paste0(outputDir, "dof-p3-processed-current.RDS"))
write_csv(p3_final, paste0(outputDir, "dof-p3-processed-current.csv"))

```

### (Required) Census Decennial for county and city-level Sex-Age-Race/Ethnicity population

Steps:

1.  Load in Census API key into session. An API key can be obtained from [here](https://api.census.gov/data/key_signup.html).

    1.  Note: Set the **.ckey** object to your Census API key.

2.  Read in decennial relationship files, which link table IDs to their corresponding sex by age by R/E stratas

3.  Call the Census API to pull county and city-level sex by age by race/ethnicity estimates from the 2020 Decennial

4.  Process outputs from Step 3

5.  Save data as .RDS and .csv into *intermediatePopData/*

    1.  *census-city-ars-currentRDS*

    2.  *census-city-ars-current.csv*

    3.  *census-county-ars-current.RDS*

    4.  *census-county-ars-current.csv*

```{r}

# Census API Key: Set your API key here, which can be obtained from
# https://api.census.gov/data/key_signup.html
.ckey   <- read_file("Standards/census.api.key.txt")
census_api_key(.ckey) # Load census API key into sesesion

# Read in Census Decennial relationship file ======================
# Links table IDs to their corresponding sex by age by R/E stratas

decLink2020 <- read_excel("Standards/decennialLink.xlsx", sheet = "2020 ARS")

# Custom Function to pull decennial census data =============================
# Calls tidycensus' get_decennial() function, and links the resultant data frame to our census dcennial relationship file

# Function arguments:
# - myYear (num): 2020 is only option
# - myGeography: "place" for city; "county" for county
# - mySumFile: "dhc" for Decennial 2020
# - cache_table (TRUE or FALSE): Whether or not to cache table names for faster future access. Defaults to FALSE; if TRUE, only needs to be called once per dataset

pullDecennial <- function(myYear = 2020, myGeography, mySumFile = "dhc", cacheTable = FALSE) {
  
  if (myYear == 2020) {
    decLink <- decLink2020
  } else {
    stop("Error: Pass in valid year")
  } 
  
  tableIDs <- unique(decLink$tableID)
  
  lapply(tableIDs, function(x, myYear1 = myYear) {
    
    tDat <- get_decennial(geography = myGeography, table = x, year = myYear1, state = 06, sumfile = mySumFile, cache_table = cacheTable) %>% 
      left_join(select(decLink, -tableID), by = c("variable" = "name")) %>% 
      mutate(year = myYear1) %>% 
      select(year, GEOID, NAME, sex, age, raceEth, population = value)
  
  
}) %>% 
  bind_rows()
}


## Call function pullDecennial() to pull 2020 Decennial Census data  ========
census2020_ars_city <- pullDecennial(myYear = 2020, myGeography = "place", mySumFile = "dhc")
census2020_ars_county <- pullDecennial(myYear = 2020, myGeography = "county", mySumFile = "dhc")

## Bind, process, and save data =======================
censusFinal_city <- census2020_ars_city %>% 
  group_by(year, GEOID, NAME, sex, age, raceEth) %>% 
  summarise(population = sum(population)) %>% 
  ungroup()

censusFinal_county <- census2020_ars_county %>% 
  group_by(year, GEOID, NAME, sex, age, raceEth) %>% 
  summarise(population = sum(population)) %>% 
  ungroup()

saveRDS(censusFinal_city, paste0(outputDir, "census-city-ars-current.RDS"))
write_csv(censusFinal_city, paste0(outputDir, "census-city-ars-current.csv"))

saveRDS(censusFinal_county, paste0(outputDir, "census-county-ars-current.RDS"))
write_csv(censusFinal_county, paste0(outputDir, "census-county-ars-current.csv"))
```

### (Optional) Department of Finance - E-4 Historical Population Estimates for Cities, Counties, and the State

Steps:

1.  Read in files from *E4/Clean/*

    1.  *E4-2011-2020.xlsx*

    2.  *E4-2021-cy.xlsx*

2.  Data processing which includes

    1.  Filtering the city portion of the data on Berkeley, Long Beach, and Pasadena

    2.  Filtering the county portion of the data on Alameda County and Los Angeles County

    3.  Calculating city to county proportion

        1.  Berkeley population / Alameda County population

        2.  Pasadena population / Los Angeles County population

        3.  Long Beach population / Los Angeles County population

3.  Save data as .RDS and .csv into *intermediatePopData/*

    1.  *dof-e4-processed-current.RDS*

    2.  *dof-e4-processed-current.csv*

```{r}

# Function for processing E4 files -----------------
process_e4 <- function(years) { 
  
  colNames <- c("place", paste0("1/1/", years))
  
  fileName <- ifelse(2021 %in% years, 
                     "E4/Clean/E4-2021-cy.xlsx",
                     paste0("E4/Clean/E4-", min(years), "-", max(years), ".xlsx"))
  
  tCountyCity <- lapply(c("County", "City"), function(x) {
    
    read_excel(fileName, skip = 1, col_names = colNames, sheet = x) %>% 
      select(place, starts_with("1")) %>% 
      mutate(across(starts_with("1"), ~as.numeric(.x))) %>% 
      pivot_longer(-place, names_to = "year", values_to = "population") %>% 
      mutate(year = as.numeric(substr(year, 5, 8)))
    
  })
  names(tCountyCity) <- c("County", "City")
  
  tCity <- tCountyCity$City %>% 
    filter(place %in% cities) %>% 
    mutate(county = ifelse(place == "Berkeley", "Alameda County", "Los Angeles County")) %>% 
    rename(city_population = population) %>% 
    left_join(rename(tCountyCity$County, county = place, county_population = population)) %>% 
    mutate(city_county_proportion = city_population / county_population, 
           county = sub(" County.*", "", county)) %>% 
    select(year, place, county, city_county_proportion)
  
}

# Process and save ---------------------------
e4_final <- bind_rows(
  process_e4(2011:2020),
  process_e4(2021:currentYear)
)

saveRDS(e4_final, paste0(outputDir, "dof-e4-processed-current.RDS"))
write_csv(e4_final, paste0(outputDir, "dof-e4-processed-current.csv"))

```

### (Optional) Department of Finance - E-6 Population Estimates and Components of Change by County

Steps:

1.  Read in files from *E6/Clean/*

    1.  *E6-2010-2019-.xlsx*

    2.  *E6-2020-cy.xlsx*

2.  Process data

3.  Save data as .RDS and .csv into *intermediatePopData/*

    1.  *dof-e6-processed-currentRDS*

    2.  *dof-e6-processed-current.csv*

```{r}

# Function for processing 1970-2009 data --------------------
process_e6 <- function(years) {
  
  fileName <- ifelse(2021 %in% years, 
                     "E6/Clean/E6-2020-cy.xlsx",
                     paste0("E6/Clean/E6-", min(years), "-", max(years), ".xlsx"))
  
  read_excel(fileName) %>% 
    rename(county = County, year = Year) %>% 
    mutate(year = as.numeric(year), 
           population = as.numeric(population))
  
}

# Process 1970-CY data -----------------------------------
e6_final <- bind_rows(process_e6(2010:2019),
                      process_e6(2020:currentYear)
                      )

# Save data --------------------------------------
saveRDS(e6_final, paste0(outputDir, "dof-e6-processed-current.RDS"))
write_csv(e6_final, paste0(outputDir, "dof-e6-processed-current.csv"))

```
