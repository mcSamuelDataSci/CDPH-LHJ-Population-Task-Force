---
title: "Generate LHJ Total Population Data"
author: "CDPH/LHJ Population Task Force"
date: "7/20/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Load packages --------------------------------------
library(readr)
library(readxl)
library(dplyr)
library(tidyr)
library(lubridate)
library(stringr)

# Standards ----------------------------------------
countyLink <- read_xlsx("Standards/countyLink.xlsx") %>% 
  select(county = countyName)


```

# Process

In **step A - Work.Rmd**, the *County July 1* total population files (DOF E6) -- historical and current -- were processed and appended. Final data saved in *intermediatePopData/* as *e6_county_julyPopEstimates_1947-.RDS/csv*

- Years range from 1947 - 2022

Additionally in **step A - Work.Rmd**, the *City and County January 1* total population files (DOF E4) -- historical and current -- were processed and appended. Final data saved in *intermediatePopData/* as *e4_city_county_julyPopEstimates_1971-.RDS/csv*

- Years range from 1971 - 2022

To generate *LHJ total* populations:

1. Read in *County July 1* total population files (DOF E6) - *e6_county_julyPopEstimates_1947-.RDS/csv*
2. Read in *City and County January 1* total population files (DOF E4) - *e4_city_county_julyPopEstimates_1971-.RDS/csv*
3. Calculate *city/county proportions* in *City and County January 1* total population data (DOF E4)
4. Apply *city/county proportions* to county numbers in *County July 1* total population data (DOF E6) to obtain *July 1 LHJ total* population estimates

# Code

## Step 1 & 2
```{r}
# Read files ---------------------------------------------

## E6 County July 1 total population file 
e6 <- readRDS("intermediatePopData/e6_county_julyPopEstimates_1947-.RDS")

## E4 City and County January 1 total population file
e4 <- readRDS("intermediatePopData/e4_city_county_janPopEstimates_1971-.RDS")

```

## Step 3. Calculate *city/county proportions* in *City and County January 1* total population data (DOF E4)
```{r}
cityCountyProportions <- e4 %>% 
  mutate(city_proportion = city_population / county_population)
```

## Step 4. Apply *city/county proportions* to county numbers in *County July 1* total population data (DOF E6) to obtain *July 1 LHJ total* population estimates
```{r}
lhjJuly <- cityCountyProportions %>% 
  select(-county_population, -city_population) %>% 
  left_join(rename(e6, county_population = population), by = c("County", "Year")) %>% 
  mutate(city_population = city_proportion * county_population)

saveRDS(lhjJuly, "finalPopData/lhjPopulation.RDS")
write_csv(lhjJuly, "finalPopData/lhjPopulation.csv")

```


