---
title: "Pulling and Processing Raw Population Data"
author: "Jaspreet Kang"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: html_document
---

```{r include=FALSE}

# Kniting Options
knitr::opts_chunk$set(eval = FALSE)
```

# Introduction

This RMarkdown file extracts and processes population data necessary for creating sex-age-race/ethnicity estimates for all 61 California Local Health Jurisdictions:

-   58 counties
-   3 city-based jurisdictions: Berkeley, Long Beach, and Pasadena
-   Alameda Health Department
-   Los Angeles Health Department

The population data files extracted and processed include:

1.  Department of Finance - E-4 Historical Population Estimates for Cities, Counties, and the State

    1.  January Estimates from 1970-2022

        1.  Excel files of these data were downloaded from [here](https://dof.ca.gov/forecasting/demographics/estimates/), and are stored in E4/Raw/. The raw data were then manually formatted for easier processing and stored into E4/Clean/.

2.  Department of Finance - E-6 Population Estimates and Components of Change by County

    1.  July Estimates from 1947-2022

        1.  Excel files of these data were downloaded from [here](https://dof.ca.gov/forecasting/demographics/estimates/), and are stored in E6/Raw/. The raw data were then manually formatted for easier processing stored into E6/Clean/.

3.  Department of Finance P3 Historical and Current Complete State and County Projections Dataset

    1.  Sex-Age-Race/Ethnicity population estimates from 2000-2022

        1.  Located in P3/

            1.  Intercensal_2000-2010_DBInput.csv contains 2000-2010 estimates. 2000-2009 estimates are used from this file.
            2.  P3_Complete.csv contains 2010-2060 estimates or projections. 2010-2019 estimates are used from this file.
            3.  P3_Complete_interim.csv contains 2020-2060 estimates or projections. Only 2020-current year of estimates are used.

4.  Census Decennial for city-level Sex-Age-Race/Ethnicity population

    1.  Extracted using R's tidycensus package. This method requires a Census API key, which can be obtained [here](https://api.census.gov/data/key_signup.html). Estimates are pulled from the 2000, 2010, and 2020 Decennial.

The processed datasets are saved as csv and RDS files into intermediatePopData/:

1.  census-city-ars
2.  dof-e4-processed
3.  dof-e6-processed
4.  dof-p3-processed

# Setup

Note: Set **.ckey** to your Census API key.

```{r setup}

# Setup ========================================================================================

# Disable scientific notation
options(scipen=999)

## Load packages ----------------------------------------------
library(readxl) # Read in excel files
library(readr) # Read in and write csv files
library(dplyr) # Data manipulation
library(tidyr) # Data reshaping
library(janitor) # Contains helpful functions for data cleaning
library(lubridate) # Date formatting
library(stringr) # String formatting
library(haven) # Read in SAS data files
library(tidycensus) # For interacting with Census API
library(DT) # Interactive tables
library(flextable) # Static tables

## Load Info Files ---------------------------------------------

# County relationship file
countyLink <- read_xlsx("Standards/countyLink.xlsx") %>% 
  select(county = countyName) %>% 
  mutate(countyName = paste0(county, " County"))

## Global constants ---------------------------------------------

# Set most recent year
currentYear <- 2022

# Census API Key
.ckey   <- read_file("Standards/census.api.key.txt")

# City LHJs
cities <- c("Berkeley", "Long Beach", "Pasadena")


# Directory to save output files to
outputDir <- "intermediatePopData/"

```

# Process and Save Data

## Department of Finance - E-4 Historical Population Estimates for Cities, Counties, and the State

```{r}

# Function for processing E4 files -----------------
process_e4 <- function(years) {
  
  colNames <- c("Place", paste0("1/1/", years))
  
  fileName <- ifelse(2021 %in% years, 
                     "E4/Clean/E4-2021-cy.xlsx",
                     paste0("E4/Clean/E4-", min(years), "-", max(years), ".xlsx"))
  
  tCountyCity <- lapply(c("County", "City"), function(x) {
    
    read_excel(fileName, skip = 1, col_names = colNames, sheet = x) %>% 
      select(Place, starts_with("1")) %>% 
      mutate(across(starts_with("1"), ~as.numeric(.x))) %>% 
      pivot_longer(-Place, names_to = "Year", values_to = "population") %>% 
      mutate(Year = as.numeric(substr(Year, 5, 8)))
    
  })
  names(tCountyCity) <- c("County", "City")
  
  tCity <- tCountyCity$City %>% 
    filter(Place %in% cities) %>% 
    mutate(County = ifelse(Place == "Berkeley", "Alameda County", "Los Angeles County")) %>% 
    rename(city_population = population) %>% 
    left_join(rename(tCountyCity$County, County = Place, county_population = population)) %>% 
    mutate(city_county_proportion = city_population / county_population)
  
}

# Process and save ---------------------------
e4_final <- bind_rows(
  process_e4(1971:1980), 
  process_e4(1981:1990),
  process_e4(1991:2000),
  process_e4(2001:2010),
  process_e4(2011:2020),
  process_e4(2021:currentYear)
)

saveRDS(e4_final, paste0(outputDir, "dof-e4-processed.RDS"))
write_csv(e4_final, paste0(outputDir, "dof-e4-processed.csv"))

```

## Department of Finance - E-6 Population Estimates and Components of Change by County

```{r}

# Process 1947-1969 data --------------------------------

e6_1947_69 <- read_excel("E6/Clean/E6-1947-1969.xlsx", col_names = c("County", 1947:1969), skip = 1) %>% 
  pivot_longer(-County, names_to = "Year", values_to = "population") %>% 
  mutate(Year = as.numeric(Year))

# Function for processing 1970-CY data --------------------
process_e6 <- function(years) {
  
  fileName <- ifelse(2021 %in% years, 
                     "E6/Clean/E6-2020-cy.xlsx",
                     paste0("E6/Clean/E6-", min(years), "-", max(years), ".xlsx"))
  
  read_excel(fileName) %>% 
    mutate(Year = as.numeric(Year), 
           population = as.numeric(population))
  
}

# Process 1970-CY data -----------------------------------
e6_final <- bind_rows(e6_1947_69, 
                      process_e6(1970:1989), 
                      process_e6(1990:1999),
                      process_e6(2000:2009),
                      process_e6(2010:2019),
                      process_e6(2020:currentYear)
                      )

# Save data --------------------------------------
saveRDS(e6_final, paste0(outputDir, "dof-e6-processed.RDS"))
write_csv(e6_final, paste0(outputDir, "dof-e6-processed.csv"))

```

## Department of Finance P3 Historical and Current Complete State and County Projections Dataset

```{r}

# Helpful objects ---------------------------------------
countyLink1 <- readxl::read_xlsx("Standards/countyLink.xlsx") %>% 
               select(countyName, CountyCode=cdphcaCountyTxt,FIPSCounty)%>%
               mutate(fips = as.numeric(paste0("6", FIPSCounty))) %>% 
               select(-FIPSCounty)

countyLink2 <- readxl::read_xlsx("Standards/countyLink.xlsx") %>% 
  select(County = countyName, fips = FIPSCounty) %>% 
  mutate(fips = as.numeric(paste0("6", fips)), 
         County = paste0(County, " County"))

ageLink <- read_xlsx("Standards/ageLink.xlsx", sheet = "standard")
raceLink <- read_xlsx("Standards/raceLink.xlsx")
raceLink_dof <- raceLink %>% 
  select(raceEth = raceNameShort, race7) %>% 
  filter(!is.na(race7))


# 2000-2009 ----------------------
p3_2000_2009 <- read_csv("P3/Intercensal_2000-2010_DBInput.csv") %>% 
                       mutate(year  = as.numeric(str_sub(Year,5,9)),
                              month = as.numeric(str_sub(Year,1,1))) %>%    # 2000 has both April and July estimates; 2010 only April; all others only July
                       filter(month == 7)  %>%
                       select(CountyCode, year, sex=Gender, race7=RaceCode, age=Age, population=Population) %>% # CountyCode - 2 digit character
                       full_join(countyLink1,by="CountyCode") %>%                                                # "01", "02" ... "58", "59"
                       filter(CountyCode != "59") %>% select(-CountyCode) %>%                                   #  58 - Yuba
                       mutate(race7 = ifelse(race7== 6,99,race7))  %>%                                          #  59 - California  -- CHECK THIS
                       mutate(race7 = ifelse(race7== 7, 6,race7))  %>%
                       mutate(race7 = ifelse(race7==99, 7,race7))  %>% 
  select(County = countyName, Year = year, sex, race7, age, population) %>% 
  mutate(County = paste0(County, " County")) %>% 
  filter(Year != 2010)

# 2010-2019 ---------------------
# Vintage 2020 (2021.7.14) version
p3_10_19 <- read_csv("P3/P3_Complete.csv") %>%
  filter(year %in% 2010:2019) %>% 
  left_join(countyLink2, by = "fips") %>% 
  mutate(sex = str_to_title(sex)) %>% 
  select(County, Year = year, sex, race7, age = agerc, population = perwt)


# 2020 - Current --------------
p3_20_ <- read_csv("P3/P3_Complete_Interim.csv") %>% 
  filter(year %in% 2020:currentYear) %>% 
  left_join(countyLink2, by = "fips") %>% 
  mutate(sex = str_to_title(sex)) %>% 
  select(County, Year = year, sex, race7, age = agerc, population = perwt)

# P3 Final ----------------------
p3_final <- bind_rows(p3_2000_2009, p3_10_19, p3_20_) %>% 
  left_join(raceLink_dof) %>% 
  select(-race7) %>% 
  mutate(age = case_when(age >= 100 ~ "100+", 
                         TRUE ~ as.character(age))) %>% 
  group_by(County, Year, sex, age, raceEth) %>% 
  summarise(population = sum(population)) %>% 
  ungroup()

# Save data --------------------------------------
saveRDS(p3_final, paste0(outputDir, "dof-p3-processed.RDS"))
write_csv(p3_final, paste0(outputDir, "dof-p3-processed.csv"))

```

## Census Decennial for city-level Sex-Age-Race/Ethnicity population

```{r}

library(tidycensus) 

# Get 2000, 2010, 2020 Decennial table IDs for Sex By Age by Race/Ethnicity ---------------------------------

## 2000 ---------------------------------
censusVars2000 <- tidycensus::load_variables(year = 2000, dataset = "sf1")

censusVars2000_total <- censusVars2000 %>% 
  filter(name == "P001001")

censusVars2000_race <- censusVars2000 %>% 
  filter(grepl("SEX BY AGE", concept)) %>% 
  filter(grepl("HISPANIC OR LATINO", concept)) %>% 
  filter(grepl("209", concept)) %>% 
  mutate(tableID = substr(name, 1, 7))

# 2010 -----------------------------------
censusVars2010 <- tidycensus::load_variables(year = 2010, dataset = "sf1")

censusVars2010_total <- censusVars2010 %>% 
  filter(name == "P001001")

censusVars2010_race <- censusVars2010 %>% 
  filter(grepl("SEX BY AGE [(]", concept)) %>% 
  filter(grepl("HISPANIC OR LATINO", concept)) %>% 
  filter(grepl("PCT", name)) %>% 
  mutate(tableID = substr(name, 1, 7))

# 2020 -----------------------------------
censusVars2020 <- tidycensus::load_variables(year = 2020, dataset = "dhc") 

censusVars2020_total <- censusVars2020 %>% 
  filter(name == "P1_001N")

censusVars2020_race <- censusVars2020 %>% 
  filter(grepl("SEX BY SINGLE-YEAR AGE [(]", concept)) %>% 
  filter(grepl("HISPANIC OR LATINO", concept)) %>% 
  mutate(tableID = substr(name, 1, 6))


# Function to create Census Linkages ---------------------
createCensusLink <- function(myData) {
  
  tDat <- myData %>% 
    mutate(raceEth = case_when(grepl("WHITE", concept) ~ "White", 
                             grepl("BLACK", concept) ~ "Black", 
                             grepl("ALASKA", concept) ~ "AI/AN", 
                             grepl("ASIAN", concept) ~ "Asian", 
                             grepl("HAWAIIAN", concept) ~ "NH/PI", 
                             grepl("OTHER", concept) ~ "Other", 
                             grepl("TWO", concept) ~ "Multi-Race", 
                             TRUE ~ "Latino"), 
         sex = case_when(grepl("Female", label) ~ "Female", 
                         grepl("Male", label) ~ "Male", 
                         TRUE ~ "Total"))
  
  if (substr(tDat$label[1], 2, 2) == "!") {
    tDat <- tDat %>% 
      mutate(label = sub(".* [!][!]", "", label), 
             label = gsub("[:]", "", label))
  }
  
  tDat %>% 
    mutate(age = case_when(grepl("Under", label) ~ "0",
                         label %in% c("Total", "Total!!Male", "Total!!Female") ~ "Total", 
                         TRUE ~ gsub(".*ale[!][!](.+) year.*", "\\1", label)), 
         age = case_when(age %in% c("100 to 104", "105 to 109", "110") ~ "100+",
                         TRUE ~ age)) %>% 
  select(tableID, name, sex, age, raceEth)
  
  
}

# Create Census Linkages --------------------------------------------------------
census2000_link <- createCensusLink(censusVars2000_race)
census2010_link <- createCensusLink(censusVars2010_race) 
census2020_link <- createCensusLink(censusVars2020_race) 
  

# Function to pull decennial data ----------------------------------------------
pullDecennial <- function(myYear, myGeography, mySumFile = "sf1") {
  
  if (myYear == 2000) {
    censusLink <- census2000_link
  } else if (myYear == 2010) {
    censusLink <- census2010_link
  } else if (myYear == 2020) {
    censusLink <- census2020_link
  }
  
  tableIDs <- unique(censusLink$tableID)
  
  lapply(tableIDs, function(x, myYear1 = myYear) {
    
    print(myYear1)
    
    tDat <- get_decennial(geography = myGeography, table = x, year = myYear1, state = 06, sumfile = mySumFile) %>% 
      left_join(select(censusLink, -tableID), by = c("variable" = "name")) %>% 
      mutate(year = myYear1) %>% 
      select(year, GEOID, NAME, sex, age, raceEth, population = value)
  
  
}) %>% 
  bind_rows()
  
  
}


## Census 2000, 2010, 2020 ------------------------------
census2000_ars_city <- pullDecennial(myYear = 2000, myGeography = "place")
census2000_ars_county <- pullDecennial(myYear = 2000, myGeography = "county")

census2010_ars_city <- pullDecennial(myYear = 2010, myGeography = "place")
census2010_ars_county <- pullDecennial(myYear = 2010, myGeography = "county")

census2020_ars_city <- pullDecennial(myYear = 2020, myGeography = "place", mySumFile = "dhc")
census2020_ars_county <- pullDecennial(myYear = 2020, myGeography = "county", mySumFile = "dhc")

## Bind  and save datadata ------------------------------
censusFinal_city <- bind_rows(census2000_ars_city, census2010_ars_city, census2020_ars_city) %>% 
  group_by(year, GEOID, NAME, sex, age, raceEth) %>% 
  summarise(population = sum(population)) %>% 
  ungroup()

censusFinal_county <- bind_rows(census2000_ars_county, census2010_ars_county, census2020_ars_county) %>% 
  group_by(year, GEOID, NAME, sex, age, raceEth) %>% 
  summarise(population = sum(population)) %>% 
  ungroup()

saveRDS(censusFinal_city, paste0(outputDir, "census-city-ars.RDS"))
write_csv(censusFinal_city, paste0(outputDir, "census-city-ars.csv"))

saveRDS(censusFinal_county, paste0(outputDir, "census-county-ars.RDS"))
write_csv(censusFinal_county, paste0(outputDir, "census-county-ars.csv"))
```